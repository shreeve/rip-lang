# Test: Loops (5 node types)
# Tests "for-in", "for-of", "while", "until", "loop" node types

# ============================================================================
# For-In Loops (Array Iteration): "for-in"
# ============================================================================

# Basic for-in
test "for-in array", "sum = 0; for x in [1, 2, 3]\n  sum += x\nsum", 6
test "for-in with index", "result = ''; for item, i in ['a', 'b', 'c']\n  result += i\nresult", "012"
test "for-in range", "sum = 0; for i in [1..5]\n  sum += i\nsum", 15

# For-in with destructuring and defaults
test "for-in destructuring with defaults", "arr = [[1, 2, 3], [4, 5], [6]]\nresult = []\nfor [a, b = 99, c = 88] in arr\n  result.push(a + b + c)\nresult", [6, 97, 193]

# Range loop without variable (N-time repetition)
test "range loop without var", "result = ''; for [1...5]\n  result += 'x'\nresult", "xxxx"
test "range loop without var with by", "result = ''; for [1...10] by 2\n  result += 'x'\nresult", "xxxxx"
test "postfix range without var", "result = ''; (result += 'x' for [1...5]); result", "xxxx"

# Code generation
code "for-in loop", "for x in arr\n  x", "for (const x of arr) { x; }"
code "range loop no var", "for [1...5]\n  doSomething()", "for (let _i = 1; _i < 5; _i++) {\n  doSomething();\n}"

# ============================================================================
# For-Of Loops (Object Iteration): "for-of"
# ============================================================================

# Basic for-of
test "for-of object", "obj = {a: 1, b: 2}; sum = 0; for key, val of obj\n  sum += val\nsum", 3
test "for-of keys only", "obj = {a: 1, b: 2}; keys = []; for key of obj\n  keys.push(key)\nkeys.length", 2

# Code generation
code "for-of loop", "for k, v of obj\n  v", "for (const k in obj) {\nconst v = obj[k];\nv;\n}"
code "for own", "for own k of obj\n  k", "for (const k in obj) {\nif (!Object.hasOwn(obj, k)) continue;\nk;\n}"
code "for own with value", "for own k, v of obj\n  v", "for (const k in obj) {\nif (!Object.hasOwn(obj, k)) continue;\nconst v = obj[k];\nv;\n}"

# ============================================================================
# While Loops: "while"
# ============================================================================

# Basic while
test "while loop", "i = 0; sum = 0; while i < 5\n  sum += i\n  i += 1\nsum", 10

# While with guard
test "while when", "i = 0\nsum = 0\nwhile i < 10\n  if i % 2 == 0\n    sum += i\n  i += 1\nsum", 20

# Postfix while
test "postfix while", "i = 0; i += 1 while i < 5; i", 5

# Code generation
code "while loop", "while cond\n  body", "while (cond) { body; }"

# ============================================================================
# Until Loops: "until"
# ============================================================================

# Basic until
test "until loop", "i = 0; until i >= 5\n  i += 1\ni", 5

# Until with guard
test "until when", "i = 0\nsum = 0\nuntil i >= 10\n  if i % 2 == 0\n    sum += i\n  i += 1\nsum", 20

# Postfix until
test "postfix until", "i = 0; i += 1 until i >= 5; i", 5

# Code generation
code "until loop", "until cond\n  body", "while (!cond) {\n  body;\n}"

# ============================================================================
# Infinite Loops: "loop"
# ============================================================================

# Loop with break
test "loop with break", "i = 0; loop\n  i += 1\n  break if i >= 5\ni", 5

# Loop with continue
test "loop with continue", "i = 0; sum = 0; loop\n  i += 1\n  continue if i % 2 != 0\n  sum += i\n  break if i >= 10\nsum", 30

# Code generation
code "infinite loop", "loop\n  body", "while (true) { body; }"

# ============================================================================
# Loop Control: break and continue
# ============================================================================

# Break statement
test "break in for-in", '''
  sum = 0
  for i in [1..10]
    break if i > 5
    sum += i
  sum
  ''', 15

# Continue statement
test "continue in for-in", '''
  sum = 0
  for i in [1..10]
    continue if i % 2 == 0
    sum += i
  sum
  ''', 25

# ============================================================================
# For-As Loops (ES6 for-of on iterables): "for-as"
# ============================================================================

# Basic for-as
test "for-as array", "sum = 0; for x as [1, 2, 3]\n  sum += x\nsum", 6
test "for-as set", "sum = 0; s = new Set([10, 20, 30]); for x as s\n  sum += x\nsum", 60

# For-as with destructuring (used in packages for Map.entries())
test "for-as destructure", '''
  m = new Map()
  m.set("a", 1)
  m.set("b", 2)
  result = []
  for [k, v] as m.entries()
    result.push("#{k}=#{v}")
  result
  ''', ["a=1", "b=2"]

test "for-as destructure array", '''
  pairs = [[1, 2], [3, 4], [5, 6]]
  sum = 0
  for [a, b] as pairs
    sum += a + b
  sum
  ''', 21

# Code generation
code "for-as loop", "for x as iter\n  x", "for (const x of iter) { x; }"
code "for-as destructure gen", "for [k, v] as m.entries()\n  k", "for (const [k, v] of m.entries()) { k; }"

# ============================================================================
# Nested Loops
# ============================================================================

test "nested for-in", '''
  sum = 0
  for i in [1, 2, 3]
    for j in [10, 20]
      sum += i * j
  sum
  ''', 180

test 'break in for loop', '''
  result = []
  for x in [1, 2, 3, 4, 5]
    if x is 3
      break
    result.push(x)
  result
  ''', [1, 2]

test 'continue in for loop', '''
  result = []
  for x in [1, 2, 3, 4, 5]
    if x is 3
      continue
    result.push(x)
  result
  ''', [1, 2, 4, 5]

test 'break with condition', '''
  i = 0
  for x in [1, 2, 3, 4, 5]
    break if x > 3
    i = x
  i
  ''', 3

test 'comprehension with break in if', '''
  result = for x in [1, 2, 3, 4, 5]
    if x is 3
      break
    x
  result
  ''', [1, 2]

test 'comprehension with continue in if', '''
  result = for x in [1, 2, 3, 4, 5]
    if x is 3
      continue
    x
  result
  ''', [1, 2, 4, 5]

code 'break in for loop', '''
  for x in arr
    if x > 5
      break
  ''', '''
  for (const x of arr) {
    if (x > 5) {
      break;
    }
  }
'''

# ============================================================================
# Range Loop Optimization
# ============================================================================

test 'range loop optimization - simple numeric', '''
  result = []
  for k in [1...5]
    result.push k
  result
  ''', [1, 2, 3, 4]

test 'range loop optimization - property access', '''
  obj = {arr: [10, 20, 30, 40]}
  result = []
  for k in [0...obj.arr.length]
    result.push obj.arr[k]
  result
  ''', [10, 20, 30, 40]

test 'inclusive range loop', '''
  result = []
  for k in [1..3]
    result.push k
  result
  ''', [1, 2, 3]

code 'range loop generates traditional for', '''
  for k in [1...10]
    console.log k
  ''', '''
  for (let k = 1; k < 10; k++) {
    console.log(k);
  }
'''

# ============================================================================
# Reverse Iteration (by -1)
# ============================================================================

test 'reverse iteration with by -1', '''
  result = []
  for x in [1, 2, 3, 4, 5] by -1
    result.push x
  result
  ''', [5, 4, 3, 2, 1]

test 'reverse iteration with break', '''
  result = []
  for x in [10, 20, 30, 40, 50] by -1
    break if x < 25
    result.push x
  result
  ''', [50, 40, 30]

test 'reverse iteration in function', '''
  fn = (arr) ->
    last = null
    for x in arr by -1
      if x > 0
        last = x
        break
    last
  fn([1, 2, -5, 3, -1])
  ''', 3

code 'reverse iteration generates countdown', '''
  for x in arr by -1
    console.log x
  ''', '''
  for (let _i = arr.length - 1; _i >= 0; _i--) {
    const x = arr[_i];
    console.log(x);
  }
'''

# ============================================================================
# loop n â€” repeat N times
# ============================================================================

test "loop n times", '''
  count = 0
  loop 3
    count++
  count
  ''', 3

test "loop n inline", '''
  arr = []
  loop 5
    arr.push arr.length
  arr
  ''', [0, 1, 2, 3, 4]

test "loop n with it as counter", '''
  arr = []
  loop 5
    arr.push it
  arr
  ''', [0, 1, 2, 3, 4]

code "loop n compiles to for", "loop 3\n  console.log 'hi'", """for (let it = 0; it < 3; it++) {\n  console.log('hi');\n}""", {skipPreamble: true}
