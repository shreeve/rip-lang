# Bookings list â€” two-column layout with detail panel

export Bookings = component
  bookings := []
  loading := true
  error := null
  selectedId := null

  beforeMount: ->
    try
      res = await fetch('/api/bookings')
      data = await res.json()
      if data.error
        @router.push '/auth'
        return
      bookings = data.bookings or []
    catch
      error = 'Failed to load bookings'
    loading = false

  currentWeek ~= Math.ceil((Date.now() - new Date(new Date().getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000))
  upcoming ~= bookings.filter (b) -> b.week >= currentWeek
  past ~= bookings.filter (b) -> b.week < currentWeek
  selected ~= bookings.find (b) -> b.id is selectedId

  selectBooking: (b) ->
    selectedId = b.id

  render
    div.('py-12')
      div.('flex justify-between')
        h1.('text-3xl font-semibold') "Bookings"
        a.('inline-flex items-center rounded-full border border-primary bg-primary px-4 py-2 text-sm font-semibold text-secondary shadow-xs transition-colors hover:border-secondary hover:bg-secondary active:bg-tertiary') href: "/booking/time", "Book session"

      if loading
        div.('flex items-center justify-center py-20')
          p.('text-tertiary') "Loading..."

      if error
        div.('mt-4 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-error') error

      unless loading or error
        if bookings.length is 0
          div.('mt-8 flex flex-col items-center gap-y-7 rounded-lg-plus border border-primary px-6 py-8 md:py-10 lg:min-w-[460px] lg:py-12')
            div.('text-[50px] text-quaternary/40') "ðŸ“‹"
            div.('flex flex-col items-center gap-y-2 text-center')
              div.('text-xl font-semibold') "No upcoming bookings"
              div.('text-sm-plus text-tertiary') "Your upcoming sessions will appear here"
            a.('inline-flex items-center rounded-full border border-primary bg-primary px-4 py-2 text-sm font-semibold text-secondary shadow-xs transition-colors hover:border-secondary hover:bg-secondary active:bg-tertiary') href: "/booking/time", "Book session"

        unless bookings.length is 0
          div.('mt-8 lg:flex lg:gap-x-15')
            div
              h2.('text-xl font-semibold') "Upcoming"
              if upcoming.length > 0
                div.('mt-4 flex flex-col gap-y-3')
                  for b in upcoming
                    button.('flex items-stretch overflow-hidden rounded-lg-plus border bg-primary transition',
                      if b.id is selectedId then 'border-brand ring ring-brand' else 'border-primary hover:border-secondary active:bg-secondary') @click: (=> @selectBooking(b))
                      div.('flex w-[80px] items-center justify-center bg-tertiary sm:w-[130px]')
                        span.('text-[35px] text-quaternary/40 md:text-[45px]') "ðŸŠ"
                      div.('flex flex-col gap-y-3.5 p-5 text-left')
                        div.('leading-none font-semibold') "One-on-One Swim Lesson"
                        div.('flex flex-col gap-y-2.5')
                          span.('text-sm text-tertiary') "Week #{b.week} Â· #{b.slot}"
                          if b.children and b.children.length > 0
                            div.('flex flex-wrap gap-1')
                              for child in b.children
                                span.('inline-flex items-center rounded-full bg-cyan-50 px-2.5 py-0.5 text-xs font-medium text-cyan-700') "#{child.name or 'Child'}"
                          else
                            span.('text-xs text-quaternary') "No children listed"

              if past.length > 0
                h2.('mt-10 text-xl font-semibold') "Past"
                div.('mt-4 flex flex-col gap-y-3')
                  for b in past
                    button.('flex items-stretch overflow-hidden rounded-lg-plus border bg-primary opacity-60 transition',
                      if b.id is selectedId then 'border-brand ring ring-brand' else 'border-primary hover:border-secondary active:bg-secondary') @click: (=> @selectBooking(b))
                      div.('flex w-[80px] items-center justify-center bg-tertiary sm:w-[130px]')
                        span.('text-[35px] text-quaternary/40 md:text-[45px]') "ðŸŠ"
                      div.('flex flex-col gap-y-3.5 p-5 text-left')
                        div.('leading-none font-semibold') "One-on-One Swim Lesson"
                        span.('text-sm text-tertiary') "Week #{b.week} Â· #{b.slot}"

            # Right column: detail panel (desktop only)
            if selected
              div.('hidden overflow-hidden rounded-lg-plus border border-primary bg-primary lg:block lg:flex-auto')
                div.('h-[250px] bg-gradient-to-br from-blue-100 to-cyan-50 flex items-center justify-center')
                  span.('text-[56px]') "ðŸŠâ€â™‚ï¸"
                div.('flex flex-col gap-y-8 px-6 py-7 md:p-7 lg:p-8')
                  div.('flex flex-col gap-y-5')
                    span.('flex h-9 items-center justify-center self-start rounded-full px-3.5 text-sm-plus font-medium text-white bg-info') "Confirmed"
                    div.('text-2xl leading-none font-semibold') "One-on-One Swim Lesson"
                  div.('flex flex-col gap-y-4')
                    div.('flex items-center gap-x-2 text-sm-plus text-tertiary')
                      span "Week #{selected.week} Â· #{selected.slot}"
                    div.('flex items-center gap-x-2 text-sm-plus text-tertiary')
                      span "2966 N 1400 E, North Logan, UT"
                  if selected.children and selected.children.length > 0
                    div.('flex flex-col gap-y-2')
                      span.('text-sm font-semibold text-secondary') "Children"
                      div.('flex flex-wrap gap-1.5')
                        for child in selected.children
                          span.('inline-flex items-center rounded-full bg-cyan-50 px-2.5 py-0.5 text-xs font-medium text-cyan-700') "#{child.name or 'Child'} (age #{child.age or '?'})"
