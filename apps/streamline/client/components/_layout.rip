# Root layout â€” sidebar nav (desktop) + top bar (mobile)

export Layout = component
  user := null
  loading := true
  menuOpen := false

  beforeMount: ->
    try
      res = await fetch('/api/user')
      data = await res.json()
      user = data.user
    catch
      user = null
    loading = false

  signOut: ->
    await fetch '/api/auth/signout', method: 'POST'
    user = null
    @router.push '/auth'

  toggleMenu: ->
    menuOpen = not menuOpen

  closeMenu: ->
    menuOpen = false

  initials ~= do ->
    return '' unless user
    parts = (user.firstName or '').split(' ')
    first = parts[0]?[0] or ''
    last = (user.lastName or '')[0] or ''
    (first + last).toUpperCase()

  displayName ~= do ->
    return '' unless user
    [user.firstName, user.lastName].filter(Boolean).join(' ') or user.email

  render
    .app-layout

      # ---- Desktop Sidebar (hidden on mobile) ----
      aside.sidebar
        .sidebar-top
          a.sidebar-brand href: "/"
            span.brand-icon "ğŸŠ"
            span "Streamline"

          if user
            .sidebar-user
              .user-avatar initials
              .user-name displayName

            nav.sidebar-nav
              a.sidebar-link href: "/booking/time"
                span.link-icon "ğŸ“…"
                span "Book a Session"
              a.sidebar-link href: "/bookings"
                span.link-icon "ğŸ“‹"
                span "My Bookings"
              a.sidebar-link href: "/profile"
                span.link-icon "ğŸ‘¤"
                span "Profile"

        .sidebar-bottom
          if user
            button.sidebar-link.btn-link @click: @signOut
              span.link-icon "ğŸšª"
              span "Sign Out"

      # ---- Mobile Top Bar (hidden on desktop) ----
      header.mobile-bar
        a.mobile-brand href: "/"
          span.brand-icon "ğŸŠ"
          span "Streamline"

        if user
          button.mobile-avatar-btn @click: @toggleMenu
            .user-avatar.user-avatar-sm initials
            span.mobile-chevron "â–¾"

        else unless loading
          a.nav-link href: "/auth", "Sign In"

      # ---- Mobile Menu Dropdown ----
      if menuOpen
        .mobile-overlay @click: @closeMenu
        .mobile-menu
          .mobile-menu-user
            .user-avatar initials
            .user-name displayName
          nav.mobile-nav
            a.mobile-nav-link href: "/booking/time", @click: @closeMenu
              span.link-icon "ğŸ“…"
              span "Book a Session"
            a.mobile-nav-link href: "/bookings", @click: @closeMenu
              span.link-icon "ğŸ“‹"
              span "My Bookings"
            a.mobile-nav-link href: "/profile", @click: @closeMenu
              span.link-icon "ğŸ‘¤"
              span "Profile"
          hr.divider
          button.mobile-nav-link.btn-link @click: @signOut
            span.link-icon "ğŸšª"
            span "Sign Out"

      # ---- Main Content ----
      main.main-content
        .content-container
          #content
