<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rip Grid — Dev</title>
  <script>
  (function() {
    // ?disable=index,grid-row — disable specific scripts to isolate errors
    var params = new URLSearchParams(location.search);
    var disable = (params.get('disable') || '').split(',').filter(Boolean);
    if (disable.length) {
      document.querySelectorAll('script[type="text/rip"]').forEach(function(s) {
        if (disable.includes(s.dataset.name)) {
          s.type = 'text/x-rip-disabled';
          console.warn('[rip] disabled: ' + s.dataset.name);
        }
      });
    }

    window.addEventListener('error', function(ev) {
      if (!ev.message || !ev.message.includes('Parse error')) return;
      var scripts = document.querySelectorAll('script[type="text/rip"]');
      var names = [];
      scripts.forEach(function(s) { names.push(s.dataset.name || '?'); });
      var msg = '[rip] Parse error in one of: ' + names.join(', ') +
        '\n  ' + ev.message +
        '\n  Isolate with: ?disable=NAME (where NAME is one of: ' + names.join(', ') + ')';
      console.error(msg);

      var el = document.createElement('div');
      el.style.cssText = 'position:fixed;top:0;left:0;right:0;padding:16px 20px;background:#fef2f2;color:#991b1b;font:14px/1.5 monospace;z-index:9999;border-bottom:2px solid #f87171';
      el.textContent = 'Rip parse error — check console. Isolate: ?disable=' + names[0];
      document.body.prepend(el);
      ev.preventDefault();
    });
  })();
  </script>
  <script type="module" src="/rip/rip-ui.min.js"></script>
  <style>
*, *::before, *::after { box-sizing: border-box; }

body {
  margin: 0;
  font-family: system-ui, -apple-system, sans-serif;
  font-size: 14px;
  color: #1e293b;
  background: #f1f5f9;
}

.grid-dev {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px;
  user-select: none;
}

.grid-toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  margin-bottom: 10px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,.08);
}

.grid-toolbar h1 {
  margin: 0;
  font-size: 16px;
  font-weight: 700;
  color: #0f172a;
}

.grid-info {
  font-size: 12px;
  color: #64748b;
  font-variant-numeric: tabular-nums;
}

.grid-container {
  position: relative;
  overflow: auto;
  height: calc(100vh - 120px);
  background: white;
  border-radius: 3px;
  box-shadow: 0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.04);
}

.rip-grid-editor {
  position: absolute;
  z-index: 10;
  box-sizing: border-box;
  border: 2px solid #3b82f6;
  border-radius: 0;
  font: 13px system-ui, -apple-system, sans-serif;
  padding: 0 8px;
  outline: none;
  background: white;
  color: #1e293b;
}

.rip-grid-editor[type="number"] { -moz-appearance: textfield; }
.rip-grid-editor::-webkit-inner-spin-button,
.rip-grid-editor::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

select.rip-grid-editor { cursor: pointer; }

.rip-grid tbody td .cell-checkbox {
  pointer-events: none;
  margin: 0;
  vertical-align: middle;
}

.grid-container:focus {
  outline: none;
}

.rip-grid {
  --row-height: 32px;
  --header-height: 36px;
  --cell-padding: 0 10px;
  --border-color: #e2e8f0;
  --header-bg: #f8fafc;
  --header-color: #475569;
  --cell-color: #1e293b;
  --stripe-bg: #f8fafc;
  --hover-bg: rgba(59, 130, 246, 0.04);
  --font: system-ui, -apple-system, sans-serif;
  --font-size: 13px;

  width: 100%;
  border-collapse: collapse;
  font-family: var(--font);
  font-size: var(--font-size);
  color: var(--cell-color);
  table-layout: fixed;
}

.rip-grid thead th {
  position: sticky;
  top: 0;
  z-index: 2;
  height: var(--header-height);
  padding: var(--cell-padding);
  background: var(--header-bg);
  color: var(--header-color);
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 2px solid var(--border-color);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  user-select: none;
}

.rip-grid tbody td {
  height: var(--row-height);
  padding: var(--cell-padding);
  border-bottom: 1px solid var(--border-color);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  cursor: cell;
  user-select: none;
}

.rip-grid tbody tr.even td {
  background: var(--stripe-bg);
}

.rip-grid tbody tr:hover td {
  background: var(--hover-bg);
}

.rip-grid tbody tr td.selected {
  background: rgba(59, 130, 246, 0.08);
}

.rip-grid tbody tr td.active {
  background: rgba(59, 130, 246, 0.12);
  outline: 2px solid #3b82f6;
  outline-offset: -2px;
  position: relative;
  z-index: 1;
}

.grid-container:not(:focus) .rip-grid tbody tr td.active {
  outline-color: #94a3b8;
  background: rgba(100, 116, 139, 0.06);
}

.rip-grid tr.spacer td {
  padding: 0;
  border: none;
  line-height: 0;
  font-size: 0;
}

@media (prefers-color-scheme: dark) {
  body { background: #0f172a; color: #e2e8f0; }
  .grid-toolbar { background: #1e293b; box-shadow: 0 1px 3px rgba(0,0,0,.3); }
  .grid-toolbar h1 { color: #f1f5f9; }
  .grid-info { color: #94a3b8; }
  .grid-container { background: #1e293b; box-shadow: 0 1px 3px rgba(0,0,0,.3); }
  .rip-grid {
    --border-color: #334155;
    --header-bg: #1e293b;
    --header-color: #cbd5e1;
    --cell-color: #e2e8f0;
    --stripe-bg: rgba(255,255,255,.02);
    --hover-bg: rgba(59, 130, 246, 0.08);
  }
  .rip-grid tbody tr td.selected {
    background: rgba(59, 130, 246, 0.15);
  }
  .rip-grid tbody tr td.active {
    background: rgba(59, 130, 246, 0.2);
    outline-color: #60a5fa;
  }
  .grid-container:not(:focus) .rip-grid tbody tr td.active {
    outline-color: #64748b;
    background: rgba(100, 116, 139, 0.1);
  }
  .rip-grid-editor {
    background: #1e293b;
    color: #e2e8f0;
    border-color: #60a5fa;
  }
}
  </style>
</head>
<body>

<script type="text/rip" data-name="index">
export Home = component

  ROW_HEIGHT    = 32
  HEADER_HEIGHT = 36
  OVERSCAN      = 5
  ROW_COUNT     = 100000
  ROLES         = ['Engineer', 'Designer', 'Manager', 'Analyst', 'Director', 'Intern', 'VP', 'Lead']

  columns := [
    { key: 'id',     title: '#',       width: 60,  align: 'right', type: 'number' }
    { key: 'name',   title: 'Name',    width: 200 }
    { key: 'active', title: 'Active',  width: 70,  align: 'center', type: 'checkbox' }
    { key: 'age',    title: 'Age',     width: 80,  align: 'right', type: 'number' }
    { key: 'role',   title: 'Role',    width: 150, type: 'select', source: ROLES }
    { key: 'salary', title: 'Salary',  width: 120, align: 'right' }
    { key: 'email',  title: 'Email',   width: 250 }
  ]

  data := do ->
    fns = ['Alice', 'Bob', 'Carol', 'Dave', 'Eve', 'Frank', 'Grace', 'Hank', 'Iris', 'Jack']
    lns = ['Smith', 'Jones', 'Brown', 'Davis', 'Wilson', 'Clark', 'Lewis', 'Hall', 'Young', 'King']
    fmt = (n) -> n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',')
    result = new Array(ROW_COUNT)
    idx = 0
    while idx < ROW_COUNT
      fn = fns[idx % fns.length]
      ln = lns[Math.floor(idx / fns.length) % lns.length]
      result[idx] =
        id: idx + 1
        name: "#{fn} #{ln}"
        active: idx % 3 isnt 0
        age: 22 + (idx % 45)
        role: ROLES[idx % ROLES.length]
        salary: "$#{fmt(50000 + (idx * 137 % 100000))}"
        email: "#{fn.toLowerCase()}.#{ln.toLowerCase()}@example.com"
      idx++
    result

  scrollTop       := 0
  containerHeight := 600
  activeRow       := -1
  activeCol       := -1
  anchorRow       := -1
  anchorCol       := -1
  selecting       := false
  editing         := false
  editValue       := ''

  totalRows   ~= data.length
  totalHeight ~= totalRows * ROW_HEIGHT
  startRow    ~= Math.max(0, Math.floor(scrollTop / ROW_HEIGHT) - OVERSCAN)
  endRow      ~= Math.min(totalRows - 1, Math.ceil((scrollTop + containerHeight) / ROW_HEIGHT) + OVERSCAN)
  offsetY     ~= startRow * ROW_HEIGHT
  bottomSpace ~= Math.max(0, (totalRows - endRow - 1) * ROW_HEIGHT)

  visibleRows ~=
    result = []
    n = startRow
    while n <= endRow
      if n >= 0 and n < totalRows
        row = data[n]
        vals = []
        for c in columns
          vals.push(row[c.key])
        result.push({ idx: n, cells: vals })
      n++
    result

  ~>
    for el in document.querySelectorAll('.rip-grid td.active, .rip-grid td.selected')
      el.classList.remove('active', 'selected')
      el.style.boxShadow = ''

    trs = document.querySelectorAll('.rip-grid tbody tr:not(.spacer)')

    if anchorRow >= 0 and activeRow >= 0 and anchorCol >= 0 and activeCol >= 0
      minR = Math.min(anchorRow, activeRow)
      maxR = Math.max(anchorRow, activeRow)
      minC = Math.min(anchorCol, activeCol)
      maxC = Math.max(anchorCol, activeCol)
      multi = minR isnt maxR or minC isnt maxC
      r = Math.max(minR, startRow)
      while r <= Math.min(maxR, endRow)
        tr = trs[r - startRow]
        if tr
          c = minC
          while c <= maxC
            td = tr.children[c]
            if td
              td.classList.add('selected')
              if multi and not selecting
                shadows = []
                shadows.push('inset 0 1px 0 0 #3b82f6') if r is minR
                shadows.push('inset 0 -1px 0 0 #3b82f6') if r is maxR
                shadows.push('inset 1px 0 0 0 #3b82f6') if c is minC
                shadows.push('inset -1px 0 0 0 #3b82f6') if c is maxC
                td.style.boxShadow = shadows.join(', ') if shadows.length > 0
            c++
        r++

    if activeRow >= startRow and activeRow <= endRow and activeCol >= 0
      tr = trs[activeRow - startRow]
      if tr
        td = tr.children[activeCol]
        if td
          td.classList.add('active')

  openEditor: (initial, cursorEnd) ->
    if activeRow < 0 or activeCol < 0 or editing
      return
    col = columns[activeCol]
    editorType = col.type or 'text'
    if editorType is 'checkbox'
      data[activeRow][col.key] = not data[activeRow][col.key]
      return
    val = data[activeRow][col.key]
    orig = String(if val? then val else '')
    selectAll = false
    if initial isnt undefined and editorType isnt 'select'
      editValue = initial
    else
      editValue = orig
      selectAll = not cursorEnd
    editing = true
    requestAnimationFrame =>
      el = document.querySelector('.rip-grid-editor')
      if el
        trs = document.querySelectorAll('.rip-grid tbody tr:not(.spacer)')
        tr = trs[activeRow - startRow]
        if tr
          td = tr.children[activeCol]
          if td
            tdRect = td.getBoundingClientRect()
            cRect = @_container.getBoundingClientRect()
            el.style.top = "#{tdRect.top - cRect.top + @_container.scrollTop}px"
            el.style.left = "#{tdRect.left - cRect.left + @_container.scrollLeft}px"
            el.style.width = "#{tdRect.width}px"
            el.style.height = "#{tdRect.height}px"
            if selectAll and el.select and el.tagName is 'INPUT'
              el.select()
            else if el.selectionStart isnt undefined
              el.selectionStart = el.value.length
              el.selectionEnd = el.value.length
            el.focus()

  commitEditor: ->
    if editing
      col = columns[activeCol]
      val = editValue
      if (col.type or 'text') is 'number'
        parsed = Number(val)
        val = if isNaN(parsed) then 0 else parsed
      data[activeRow][col.key] = val
      editing = false
      @_container.focus() if @_container

  cancelEditor: ->
    editing = false
    @_container.focus() if @_container

  handleEditorInput: (e) ->
    editValue = e.target.value

  handleSelectChange: (e) ->
    editValue = e.target.value
    @commitEditor()

  handleEditorKeydown: (e) ->
    numCols = columns.length
    switch e.key
      when 'Enter'
        e.preventDefault()
        @commitEditor()
        if e.shiftKey
          if activeRow > 0
            activeRow = activeRow - 1
            @scrollToRow(activeRow)
        else
          if activeRow < totalRows - 1
            activeRow = activeRow + 1
            @scrollToRow(activeRow)
        anchorRow = activeRow
        anchorCol = activeCol
      when 'Tab'
        e.preventDefault()
        @commitEditor()
        if e.shiftKey
          if activeCol > 0
            activeCol = activeCol - 1
          else if activeRow > 0
            activeRow = activeRow - 1
            activeCol = numCols - 1
            @scrollToRow(activeRow)
        else
          if activeCol < numCols - 1
            activeCol = activeCol + 1
          else if activeRow < totalRows - 1
            activeRow = activeRow + 1
            activeCol = 0
            @scrollToRow(activeRow)
        anchorRow = activeRow
        anchorCol = activeCol
      when 'Escape'
        e.preventDefault()
        @cancelEditor()

  handleDblclick: (e) ->
    td = e.target.closest('td')
    if td and not td.parentElement.classList.contains('spacer')
      @openEditor()

  handleScroll: (e) ->
    @commitEditor() if editing
    @_nextST = e.currentTarget.scrollTop
    if not @_rafPending
      @_rafPending = true
      requestAnimationFrame =>
        scrollTop = @_nextST
        @_rafPending = false

  scrollToRow: (row) ->
    el = @_container
    if el
      top = row * ROW_HEIGHT
      if top < el.scrollTop
        el.scrollTop = top
      else if top + ROW_HEIGHT + HEADER_HEIGHT > el.scrollTop + containerHeight
        el.scrollTop = top + ROW_HEIGHT + HEADER_HEIGHT - containerHeight

  handleMousedown: (e) ->
    if e.button isnt 0
      return
    if e.target.classList.contains('rip-grid-editor')
      return
    @commitEditor() if editing
    td = e.target.closest('td')
    if td and not td.parentElement.classList.contains('spacer')
      e.preventDefault()
      @_container.focus() if @_container
      selecting = true
      el = @_container
      rect = el.getBoundingClientRect()
      ri = Math.floor((e.clientY - rect.top + el.scrollTop - HEADER_HEIGHT) / ROW_HEIGHT)
      if ri >= 0 and ri < totalRows
        activeRow = ri
        activeCol = td.cellIndex
        if not e.shiftKey
          anchorRow = ri
          anchorCol = td.cellIndex

  handleMouseup: (e) ->
    selecting = false

  handleMousemove: (e) ->
    if e.buttons isnt 1 or anchorRow < 0
      return
    el = @_container
    rect = el.getBoundingClientRect()
    ri = Math.floor((e.clientY - rect.top + el.scrollTop - HEADER_HEIGHT) / ROW_HEIGHT)
    ri = Math.max(0, Math.min(totalRows - 1, ri))
    td = e.target.closest('td')
    ci = if td and not td.parentElement.classList.contains('spacer') then td.cellIndex else anchorCol
    anchorRow = ri
    anchorCol = ci
    @scrollToRow(ri)

  handleKeydown: (e) ->
    if editing
      return
    numCols = columns.length
    key = e.key
    switch key
      when 'ArrowDown'
        e.preventDefault()
        if activeRow < 0
          activeRow = 0
          activeCol = 0 if activeCol < 0
        else if e.ctrlKey or e.metaKey
          activeRow = totalRows - 1
        else if activeRow < totalRows - 1
          activeRow = activeRow + 1
        @scrollToRow(activeRow)
      when 'ArrowUp'
        e.preventDefault()
        if e.ctrlKey or e.metaKey
          activeRow = 0
          activeCol = 0 if activeCol < 0
        else if activeRow > 0
          activeRow = activeRow - 1
        @scrollToRow(activeRow)
      when 'ArrowRight'
        e.preventDefault()
        if activeCol < 0
          activeCol = 0
          activeRow = 0 if activeRow < 0
        else if e.ctrlKey or e.metaKey
          activeCol = numCols - 1
        else if activeCol < numCols - 1
          activeCol = activeCol + 1
      when 'ArrowLeft'
        e.preventDefault()
        if e.ctrlKey or e.metaKey
          activeCol = 0
          activeRow = 0 if activeRow < 0
        else if activeCol > 0
          activeCol = activeCol - 1
      when 'Home'
        e.preventDefault()
        if e.ctrlKey or e.metaKey
          activeRow = 0
          activeCol = 0
          @scrollToRow(0)
        else
          activeRow = 0 if activeRow < 0
          activeCol = 0
      when 'End'
        e.preventDefault()
        if e.ctrlKey or e.metaKey
          activeRow = totalRows - 1
          activeCol = numCols - 1
          @scrollToRow(activeRow)
        else
          activeRow = 0 if activeRow < 0
          activeCol = numCols - 1
      when 'Tab'
        e.preventDefault()
        if activeRow < 0 or activeCol < 0
          activeRow = 0
          activeCol = 0
        else if e.shiftKey
          if activeCol > 0
            activeCol = activeCol - 1
          else if activeRow > 0
            activeRow = activeRow - 1
            activeCol = numCols - 1
            @scrollToRow(activeRow)
        else
          if activeCol < numCols - 1
            activeCol = activeCol + 1
          else if activeRow < totalRows - 1
            activeRow = activeRow + 1
            activeCol = 0
            @scrollToRow(activeRow)
      when 'Enter'
        e.preventDefault()
        if activeRow < 0 or activeCol < 0
          activeRow = 0
          activeCol = 0
        else
          @openEditor()
          return
      when 'F2'
        e.preventDefault()
        if activeRow >= 0 and activeCol >= 0
          @openEditor(undefined, true)
        return
      when 'PageDown'
        e.preventDefault()
        rows = Math.floor(containerHeight / ROW_HEIGHT)
        activeRow = Math.min(totalRows - 1, activeRow + rows)
        activeCol = 0 if activeCol < 0
        @scrollToRow(activeRow)
      when 'PageUp'
        e.preventDefault()
        rows = Math.floor(containerHeight / ROW_HEIGHT)
        activeRow = Math.max(0, activeRow - rows)
        activeCol = 0 if activeCol < 0
        @scrollToRow(activeRow)
      when 'Escape'
        anchorRow = activeRow
        anchorCol = activeCol
        return
      when ' '
        if activeRow >= 0 and activeCol >= 0
          col = columns[activeCol]
          if (col.type or 'text') is 'checkbox'
            e.preventDefault()
            data[activeRow][col.key] = not data[activeRow][col.key]
        return
      when 'Delete', 'Backspace'
        if activeRow >= 0 and activeCol >= 0 and not e.ctrlKey and not e.metaKey
          e.preventDefault()
          col = columns[activeCol]
          editorType = col.type or 'text'
          if editorType is 'checkbox'
            data[activeRow][col.key] = false
          else if editorType is 'number'
            data[activeRow][col.key] = 0
          else
            data[activeRow][col.key] = ''
        return
      when 'a'
        if e.ctrlKey or e.metaKey
          e.preventDefault()
          anchorRow = 0
          anchorCol = 0
          activeRow = totalRows - 1
          activeCol = numCols - 1
        return
      else
        if key.length is 1 and not e.ctrlKey and not e.metaKey and not e.altKey
          if activeRow >= 0 and activeCol >= 0
            editorType = (columns[activeCol].type or 'text')
            if editorType is 'text' or editorType is 'number'
              e.preventDefault()
              @openEditor(key)
        return

    extending = e.shiftKey and key isnt 'Tab' and key isnt 'Enter'
    if not extending
      anchorRow = activeRow
      anchorCol = activeCol

  mounted: ->
    @_container = document.querySelector('.grid-container')
    if @_container
      handler = (entries) =>
        for entry in entries
          containerHeight = entry.contentRect.height
      @_resizeObs = new ResizeObserver(handler)
      @_resizeObs.observe(@_container)
      @_container.focus()

  unmounted: ->
    if @_resizeObs
      @_resizeObs.disconnect()

  render
    .grid-dev
      .grid-toolbar
        h1 "Rip Grid"
        span.grid-info
          if activeRow >= 0
            "R#{activeRow + 1}:C#{activeCol + 1}"
            if anchorRow >= 0 and (anchorRow isnt activeRow or anchorCol isnt activeCol)
              h = Math.abs(activeRow - anchorRow) + 1
              w = Math.abs(activeCol - anchorCol) + 1
              " [#{h}×#{w}]"
            " | "
          "#{totalRows.toLocaleString()} rows"

      .grid-container tabindex: 0, @scroll: @handleScroll, @mousedown: @handleMousedown, @mousemove: @handleMousemove, @mouseup: @handleMouseup, @keydown: @handleKeydown, @dblclick: @handleDblclick
        if editing
          editorType = columns[activeCol].type or 'text'
          if editorType is 'select'
            select.rip-grid-editor @change: @handleSelectChange, @keydown: @handleEditorKeydown
              for opt in (columns[activeCol].source or [])
                option value: opt, selected: (opt is editValue)
                  "#{opt}"
          else
            input.rip-grid-editor type: editorType, value: editValue, @input: @handleEditorInput, @keydown: @handleEditorKeydown
        table.rip-grid
          colgroup
            for c in columns
              col style: "width: #{c.width}px"
          thead
            tr
              for c in columns
                th style: "text-align: #{c.align or 'left'}"
                  "#{c.title}"
          tbody
            if offsetY > 0
              tr.spacer
                td colspan: columns.length, style: "height: #{offsetY}px"
            for row in visibleRows
              GridRow row: row, columns: columns
            if bottomSpace > 0
              tr.spacer
                td colspan: columns.length, style: "height: #{bottomSpace}px"
</script>

<script type="text/rip" data-name="grid-row">
export GridRow = component
  @row := {}
  @columns := []

  render
    tr.(row.idx % 2 is 0 and 'even')
      for c, ci in columns
        td style: "text-align: #{c.align or 'left'}"
          if c.type is 'checkbox'
            input.cell-checkbox type: 'checkbox', checked: row.cells[ci]
          else
            row.cells[ci]
</script>

</body>
</html>
