# Root layout - sidebar nav (desktop) + top bar (mobile)

export Layout = component
  user := null
  loading := true
  menuOpen := false

  beforeMount: ->
    try
      res = await fetch('/api/user')
      data = await res.json()
      user = data.user
    catch
      user = null
    loading = false

  signOut: ->
    await fetch '/api/auth/signout', method: 'POST'
    user = null
    @router.push '/auth'

  toggleMenu: ->
    menuOpen = not menuOpen

  closeMenu: ->
    menuOpen = false

  initials ~=
    return '' unless user
    parts = (user.firstName or '').split(' ')
    first = parts[0]?[0] or ''
    last = (user.lastName or '')[0] or ''
    (first + last).toUpperCase()

  displayName ~=
    return '' unless user
    [user.firstName, user.lastName].filter(Boolean).join(' ') or user.email

  render
    .('min-h-dvh xl:flex')

      # ---- Desktop Sidebar (hidden below xl) ----
      aside.('hidden xl:sticky xl:top-0 xl:left-0 xl:flex xl:h-dvh xl:w-[250px] xl:flex-col xl:justify-between xl:border-r xl:border-primary xl:bg-primary xl:px-4 xl:py-5')
        .
          a.('mb-7 ml-3.5 block text-lg font-bold text-brand') href: "/"
            span "ğŸŠ Streamline"

          if user
            .('ml-3.5 overflow-hidden text-base-plus leading-tight font-semibold text-ellipsis')
              displayName
            nav.('mt-3 flex flex-col gap-y-0.5')
              a.('flex h-11 items-center gap-x-3 rounded-lg px-3.5 text-sm-plus font-medium transition-colors hover:bg-tertiary/70 active:bg-quaternary/60') href: "/booking/time"
                span.('text-base w-5 text-center') "ğŸ“…"
                span "Book a Session"
              a.('flex h-11 items-center gap-x-3 rounded-lg px-3.5 text-sm-plus font-medium transition-colors hover:bg-tertiary/70 active:bg-quaternary/60') href: "/bookings"
                span.('text-base w-5 text-center') "ğŸ“‹"
                span "My Bookings"
              a.('flex h-11 items-center gap-x-3 rounded-lg px-3.5 text-sm-plus font-medium transition-colors hover:bg-tertiary/70 active:bg-quaternary/60') href: "/profile"
                span.('text-base w-5 text-center') "ğŸ‘¤"
                span "Profile"

        .('mb-1 flex flex-col gap-y-4')
          if user
            button.('ml-3.5 flex items-center gap-x-3 text-sm-plus font-medium text-secondary transition-colors hover:text-brand active:pointer-coarse:text-brand active:pointer-fine:opacity-70') @click: @signOut
              span.('text-base w-5 text-center') "ğŸšª"
              span "Sign Out"

      # ---- Mobile Top Bar (hidden on desktop) ----
      .('min-h-dvh bg-secondary xl:w-0 xl:flex-auto xl:min-h-0')
        header.('flex xl:hidden h-[80px] items-center justify-between border-b border-primary bg-primary px-5')
          a.('text-base-plus font-bold text-brand') href: "/"
            span "ğŸŠ Streamline"

          if user
            button.('flex h-12 items-center rounded-full border border-primary bg-primary p-0.5 transition-colors hover:border-secondary hover:bg-secondary active:bg-tertiary') @click: @toggleMenu
              .('size-10 overflow-hidden rounded-full')
                .('size-full flex items-center justify-center bg-brand/12 text-xs-plus font-semibold text-brand uppercase')
                  initials
              span.('px-3 text-lg text-secondary') "â–¾"

          else unless loading
            a.('text-sm-plus font-medium text-secondary transition-colors hover:text-brand active:pointer-coarse:text-brand active:pointer-fine:opacity-70') href: "/auth", "Sign In"

        # ---- Mobile Menu Dropdown ----
        if menuOpen
          .('fixed inset-0 z-50 bg-black/15') @click: @closeMenu
          .('fixed top-[88px] right-4 z-50 min-w-[250px] rounded-lg-plus border border-primary bg-primary px-3 pt-6 pb-5 shadow-xl/7') style: "animation: menuFadeIn 200ms cubic-bezier(0.35, 0.91, 0.33, 0.97)"
            .('ml-3.5 overflow-hidden text-base-plus leading-tight font-semibold text-ellipsis')
              displayName
            nav.('mt-3 flex flex-col gap-y-0.5')
              a.('flex h-11 items-center gap-x-3 rounded-lg px-3.5 text-sm-plus font-medium transition-colors hover:bg-tertiary/70 active:bg-quaternary/60') href: "/booking/time", @click: @closeMenu
                span.('text-base w-5 text-center') "ğŸ“…"
                span "Book a Session"
              a.('flex h-11 items-center gap-x-3 rounded-lg px-3.5 text-sm-plus font-medium transition-colors hover:bg-tertiary/70 active:bg-quaternary/60') href: "/bookings", @click: @closeMenu
                span.('text-base w-5 text-center') "ğŸ“‹"
                span "My Bookings"
              a.('flex h-11 items-center gap-x-3 rounded-lg px-3.5 text-sm-plus font-medium transition-colors hover:bg-tertiary/70 active:bg-quaternary/60') href: "/profile", @click: @closeMenu
                span.('text-base w-5 text-center') "ğŸ‘¤"
                span "Profile"
            .('mx-3.5 mt-6 mb-5 border-t border-primary')
            button.('ml-3.5 flex items-center gap-x-3 text-sm-plus font-medium text-secondary transition-colors hover:text-brand active:pointer-coarse:text-brand active:pointer-fine:opacity-70') @click: @signOut
              span.('text-base w-5 text-center') "ğŸšª"
              span "Sign Out"

        # ---- Main Content ----
        .('px-5')
          .('mx-auto max-w-[940px] py-6 md:py-8 xl:py-10')
            #content
