#!/usr/bin/env bun
// ==============================================================================
// Build Schema Parser - Generate parser from schema grammar using Solar
// ==============================================================================

import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const rootDir = path.resolve(__dirname, '..');

async function build() {
  console.log('Building schema parser...\n');

  // Load Solar generator
  const { Generator } = await import('../src/grammar/solar.rip');

  // Load schema grammar
  const grammar = (await import('../packages/schema/grammar.rip')).default;

  console.log('Grammar loaded:', {
    mode: grammar.mode,
    rules: Object.keys(grammar.grammar).length,
    operators: grammar.operators?.length || 0
  });

  // Generate parser
  const generator = new Generator(grammar);
  const parserCode = generator.generate();

  // Output statistics
  console.log('\nParser statistics:');
  console.log(`  Tokens: ${Object.keys(generator.tokenNames || {}).length}`);
  console.log(`  Types: ${Object.keys(generator.types || {}).length}`);
  console.log(`  Rules: ${generator.rules?.length || 0}`);
  console.log(`  States: ${generator.states?.length || 0}`);
  console.log(`  Conflicts: ${generator.conflicts || 0}`);

  // Write parser
  const outputPath = path.join(rootDir, 'packages', 'schema', 'parser.js');

  // Combine with lexer import - insert lexer import at top and attach after parser creation
  const fullCode = `// Schema Parser - Generated by Solar
// DO NOT EDIT - This file is auto-generated from packages/schema/grammar.rip

import { SchemaLexer } from './lexer.js';

${parserCode.replace(
  'const parser = /*#__PURE__*/createParser()',
  'const parser = /*#__PURE__*/createParser()\nparser.lexer = new SchemaLexer()'
)}
`;

  fs.writeFileSync(outputPath, fullCode);
  console.log(`\nParser written to: ${outputPath}`);

  // Show any conflicts
  if (generator.conflictDetails?.length > 0) {
    console.log('\nConflict details:');
    for (const conflict of generator.conflictDetails.slice(0, 10)) {
      console.log(`  State ${conflict.state}: ${conflict.lookaheadName} - ${conflict.resolution}`);
    }
    if (generator.conflictDetails.length > 10) {
      console.log(`  ... and ${generator.conflictDetails.length - 10} more`);
    }
  }
}

build().catch(err => {
  console.error('Build failed:', err);
  process.exit(1);
});
